<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>رفع ملف وإضافة تقييم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for RTL and alignment */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f7f6;
        }
        .star-rating input {
            display: none;
        }
        .star-rating label {
            font-size: 2rem;
            color: #ccc;
            cursor: pointer;
            transition: color 0.2s;
        }
        .star-rating input:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #ffc107;
        }
        .star-rating {
            display: flex;
            flex-direction: row-reverse; /* To make stars align correctly with RTL */
            justify-content: center;
        }
    </style>
</head>
<body class="p-8">

    <div class="max-w-3xl mx-auto bg-white p-8 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">نظام رفع الملفات والتقييم (للمسؤول فقط )</h1>
        <p class="text-gray-600 mb-8 text-center">هذه الواجهة تتيح لك رفع الملفات مباشرة إلى Cloudinary وإضافة التقييم والتعليق، وحفظ البيانات في Google Form.</p>

        <form id="uploadForm" class="space-y-6">
            <!-- File Input -->
            <div>
                <label for="fileInput" class="block text-lg font-medium text-gray-700 mb-2">اختر الملف:</label>
                <input type="file" id="fileInput" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            </div>

            <!-- Rating Input -->
            <div>
                <label class="block text-lg font-medium text-gray-700 mb-2 text-center">التقييم:</label>
                <div class="star-rating">
                    <input type="radio" id="star5" name="rating" value="5" required><label for="star5" title="5 نجوم">★</label>
                    <input type="radio" id="star4" name="rating" value="4"><label for="star4" title="4 نجوم">★</label>
                    <input type="radio" id="star3" name="rating" value="3"><label for="star3" title="3 نجوم">★</label>
                    <input type="radio" id="star2" name="rating" value="2"><label for="star2" title="2 نجوم">★</label>
                    <input type="radio" id="star1" name="rating" value="1"><label for="star1" title="1 نجمة">★</label>
                </div>
            </div>

            <!-- Comment Input -->
            <div>
                <label for="comment" class="block text-lg font-medium text-gray-700 mb-2">التعليق/التوضيح:</label>
                <textarea id="comment" rows="4" placeholder="أضف تعليقًا أو توضيحًا للملف..."
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>

            <!-- Upload Button -->
            <button type="submit" id="uploadButton"
                    class="w-full bg-indigo-600 text-white py-3 rounded-lg text-xl font-semibold hover:bg-indigo-700 transition duration-200 disabled:bg-gray-400">
                رفع الملف
            </button>

            <!-- Progress Bar -->
            <div id="progressBarContainer" class="hidden mt-4">
                <p class="text-sm text-gray-600 mb-1" id="progressText">جاري الرفع: 0%</p>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <!-- Result Message -->
            <div id="resultMessage" class="mt-4 p-4 rounded-lg text-center hidden"></div>
        </form>
    </div>

    <script>
        // Configuration (MUST be public keys)
        // ----------------------------------------------------------------------------------
        // 1. تأكد من اسم السحابة (Cloud Name)
        const CLOUDINARY_CLOUD_NAME = 'dftm7jxqa'; // تأكد أن هذا هو اسم السحابة الخاص بك
        // ----------------------------------------------------------------------------------
        const CLOUDINARY_UPLOAD_PRESET = 'unsigned_upload_preset'; // اسم الإعداد المسبق للرفع

        // --- Google Form Configuration ---
        const GOOGLE_FORM_ACTION_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdsXQAHZ3y_zJK1FKxrx-lasA5UsJLZWQCdqjRuZhGs7YGjrw/formResponse';
        
        // هذه الأرقام هي افتراضية. إذا لم يعمل، يجب استبدالها بالأرقام الصحيحة.
        const ENTRY_IDS = {
            fileLink: 'entry.377814605', // رابط الملف
            fileName: 'entry.123456789', // اسم الملف (افتراضي )
            rating: 'entry.987654321',   // التقييم (افتراضي)
            comment: 'entry.112233445',  // التعليق (افتراضي)
        };

        const form = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const uploadButton = document.getElementById('uploadButton');
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const resultMessage = document.getElementById('resultMessage');

        // Function to send data to Google Form
        const sendDataToGoogleForm = async (fileUrl, fileName, rating, comment) => {
            const formData = new FormData();
            formData.append(ENTRY_IDS.fileLink, fileUrl);
            formData.append(ENTRY_IDS.fileName, fileName);
            formData.append(ENTRY_IDS.rating, rating);
            formData.append(ENTRY_IDS.comment, comment);

            // Send data to Google Form using a hidden iframe to avoid CORS issues
            const iframe = document.createElement('iframe');
            iframe.name = 'googleFormIframe';
            iframe.style.display = 'none';
            document.body.appendChild(iframe);

            const formElement = document.createElement('form');
            formElement.action = GOOGLE_FORM_ACTION_URL;
            formElement.method = 'POST';
            formElement.target = 'googleFormIframe';
            
            for (const [key, value] of formData.entries()) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                formElement.appendChild(input);
            }

            document.body.appendChild(formElement);
            formElement.submit();
            document.body.removeChild(formElement);
            document.body.removeChild(iframe);
        };

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const file = fileInput.files[0];
            const rating = document.querySelector('input[name="rating"]:checked')?.value;
            const comment = document.getElementById('comment').value;

            if (!file || !rating) {
                alert('الرجاء اختيار ملف وتحديد تقييم.');
                return;
            }

            uploadButton.disabled = true;
            uploadButton.textContent = 'جاري الرفع...';
            progressBarContainer.classList.remove('hidden');
            resultMessage.classList.add('hidden');

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                formData.append('cloud_name', CLOUDINARY_CLOUD_NAME);

                const xhr = new XMLHttpRequest();
                // ----------------------------------------------------------------------------------
                // 2. التعديل المطلوب: تم تغيير auto/upload إلى upload
                xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`, true );
                // ----------------------------------------------------------------------------------

                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded * 100) / e.total);
                        progressBar.style.width = `${percent}%`;
                        progressText.textContent = `جاري الرفع: ${percent}%`;
                    }
                });

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        uploadButton.disabled = false;
                        uploadButton.textContent = 'رفع الملف';
                        progressBarContainer.classList.add('hidden');

                        if (xhr.status === 200) {
                            const response = JSON.parse(xhr.responseText);
                            const fileUrl = response.secure_url;
                            const fileName = response.original_filename;
                            
                            // --- SUCCESS ---
                            sendDataToGoogleForm(fileUrl, fileName, rating, comment);

                            resultMessage.classList.remove('hidden');
                            resultMessage.classList.remove('bg-red-100', 'text-red-800');
                            resultMessage.classList.add('bg-green-100', 'text-green-800');
                            resultMessage.innerHTML = `
                                <p class="font-bold">تم الرفع بنجاح!</p>
                                <p>تم إرسال البيانات إلى Google Form.</p>
                                <p><strong>الملف:</strong> <a href="${fileUrl}" target="_blank" class="text-blue-600 hover:underline">${fileName}</a></p>
                                <p><strong>التقييم:</strong> ${rating} نجوم</p>
                                <p><strong>التعليق:</strong> ${comment || 'لا يوجد'}</p>
                            `;
                            
                            // Reset form
                            form.reset();
                            progressBar.style.width = '0%';
                            progressText.textContent = 'جاري الرفع: 0%';

                        } else {
                            // --- ERROR ---
                            resultMessage.classList.remove('hidden');
                            resultMessage.classList.remove('bg-green-100', 'text-green-800');
                            resultMessage.classList.add('bg-red-100', 'text-red-800');
                            resultMessage.innerHTML = `<p class="font-bold">فشل الرفع!</p><p>الرجاء التأكد من إعدادات Cloudinary.</p>`;
                            console.error('Cloudinary Upload Error:', xhr.responseText);
                        }
                    }
                };

                xhr.send(formData);

            } catch (error) {
                uploadButton.disabled = false;
                uploadButton.textContent = 'رفع الملف';
                progressBarContainer.classList.add('hidden');
                resultMessage.classList.remove('hidden');
                resultMessage.classList.remove('bg-green-100', 'text-green-800');
                resultMessage.classList.add('bg-red-100', 'text-red-800');
                resultMessage.innerHTML = `<p class="font-bold">حدث خطأ غير متوقع!</p>`;
                console.error(error);
            }
        });
    </script>
</body>
</html>
